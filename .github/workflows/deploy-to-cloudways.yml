name: Deploy to Cloudways

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Cloudways via rsync
        uses: burnett01/rsync-deployments@7.0.1
        with:
          switches: -avzr --delete --no-perms --no-owner --no-group --omit-dir-times --exclude='.git*' --exclude='node_modules' --exclude='var/cache/*' --exclude='var/log/*' --exclude='.env.local' --exclude='.idea'
          path: ./
          remote_path: /home/master/applications/wwtemsfcqh/public_html/
          remote_host: ${{ secrets.SSH_HOST }}
          remote_user: ${{ secrets.SSH_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Run post-deployment commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Navigate to project folder
            cd /home/master/applications/wwtemsfcqh/public_html

            # Set production environment
            export APP_ENV=prod

            # Signal messenger workers to stop gracefully
            echo "Signaling messenger workers to stop..."
            php bin/console messenger:stop-workers || true

            # Wait for workers to finish current jobs and stop (max 65 seconds for time-limited workers)
            echo "Waiting for workers to stop gracefully..."
            sleep 70

            # Create and set permissions for var directories
            mkdir -p var/cache var/log
            chmod -R 775 var/

            # Install Dependencies (Optimized for Prod)
            composer install --no-dev --optimize-autoloader

            # Run Migrations (Safe for prod)
            # php bin/console doctrine:migrations:migrate --no-interaction

            # Compile assets for production
            php bin/console asset-map:compile --env=prod

            # Ensure compiled assets are readable
            chmod -R 755 public/assets

            # Clear and Warm Cache
            php bin/console cache:clear --env=prod
            php bin/console cache:warmup --env=prod

            # Ensure cache and log directories remain writable
            chmod -R 775 var/cache var/log

            # Note: Messenger workers will be automatically restarted by the cronjob within 60 seconds
            echo "Deployment complete. Messenger workers will restart via cronjob."