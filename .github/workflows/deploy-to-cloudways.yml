name: Deploy to Cloudways

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Cloudways via rsync
        uses: burnett01/rsync-deployments@7.0.1
        with:
          switches: -avzr --delete --no-perms --no-owner --no-group --omit-dir-times --exclude='.git*' --exclude='node_modules' --exclude='var/cache/*' --exclude='var/log/*' --exclude='.env.local' --exclude='.idea'
          path: ./
          remote_path: /home/master/applications/wwtemsfcqh/public_html/
          remote_host: ${{ secrets.SSH_HOST }}
          remote_user: ${{ secrets.SSH_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Run post-deployment commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Navigate to project folder
            cd /home/master/applications/wwtemsfcqh/public_html

            # Set production environment
            export APP_ENV=prod

            # Install Dependencies (Optimized for Prod)
            composer install --no-dev --optimize-autoloader

            # Run Migrations (Safe for prod)
            # php bin/console doctrine:migrations:migrate --no-interaction

            # Clear and Warm Cache
            php bin/console cache:clear --env=prod
            php bin/console cache:warmup --env=prod
            
            # Optional: Install Node assets if you use Webpack Encore
            # npm install && npm run build